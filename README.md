# Базовая архитектура

Мной был реализован сервис умного дома с использованием микровервисов на NestJS.

Проект содержит:

-   API Gateway, который является точкой входа для пользователей и девайсов. Он и распределяет трафик по микросервисам

-   Kafka, с помощью которой осуществялется взамодействие между сервисами

-   Device Service сервис для работы с утройствами. Здесь находится возможность зарегистрировать новые устройтва или отправить команду девайсу. В этом сервисе хранится техническая информация обо всех девайсах (так как в будущем в компании будет не только сервис для отопления)

-   Heating Service сервис для управления отоплением. В нём хранятся настройки отопления для всех устройств и через него можно устанавливать желаему температуру, а также отправлять в Device Service запрос на включение или отключение отопления, если температура стала больше/меньше желаемой

-   Telemetry Service сервис телеметрии для Heating Service. Собирает данные с датчиков, хранит историю температур и передаёт в Kafka сообщения об изменении температуры

В данном проекте подготовлено MVP с тремя основными сервисами. В дальнейшем можно будет расширить архитектуру и добавить множество разных сервисов: управление освещением, камерами, замками.

## Запуск docker

```bash
docker compose up
```

## Swagger

Swagger документацию вы сможете найти по адресу `http://localhost:3333/api`

## Как протестировать?

Можно сделать несколько curl-запросов в API GATEWAY, чтобы проверить работоспособность сервисов и их общение через Kafka

1. Создание девайса типа "отопление"

В базе device_db появится новая запись. А если `service` будет равен `heating`, то в кафку улетит сообщение на создание нового устройства для обогрева

```bash
curl -X 'POST' \
  'http://localhost:3333/' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
"deviceTypeId": "type-1",
"houseId": "sweet-home",
"serialNumber": "123",
"service": "heating",
"name": "heater-3000"
}'
```

2. Отправка телеметрии

У устройства для обогрева выставляется дефолтный `targetTemperature`. Сервис телеметрии шлёт сообщения в Kafka, когда получает данные. `HeatingService` получает эти данные и решает, стоит ли послать в Kafka сообщение о том, что устройство отопления надо включить или выключить. Обычно он принимает решение, когда температура больше или меньше на 1 градус

Поэтому при отправке этого запроса device_service пошлёт команду устройсву: `set_heating_status, parameters: {"status":"off"}`

```bash
curl -X 'POST' \
  'http://localhost:3333/set-telemetry/0ad46358-810f-4465-922a-dfa15563e0c6' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{"value": 35, "unit": "C", "timestamp": "2024-09-21 23:54:40.506154+00"}'
```

3. Обновление targetTemperature

Мы можем обновить `targetTemperature` до 34 градусов, чтобы устройство не реагировало на температуру 35 градусов

```bash
curl -X 'PUT' \
  'http://localhost:3333/set-target-temperature/0ad46358-810f-4465-922a-dfa15563e0c6' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{"targetTemperature": 34}'
```

И тогда при вызове команды выше по отправке телеметрии в 35 градуса в Kafka не полетит запрос от `HeatingService` на изменение температуры девайса

## Задания первой части:

-   [Задание 1.1 по анализу монолита](./docs/tasks/task_1-1.md)

-   [Задание 1.2 по архитектуре микросервисов](./docs/tasks/task_1-2.md)

-   [Задание 1.3 по ER-диаграмме](./docs/tasks/task-1-3.md)

-   [Задание 1.4 по документрированию апи](./docs/api)
